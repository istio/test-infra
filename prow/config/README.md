# Istio Prow Job Configuration

This package defines and generates all prow jobs that will be run in pre/postsubmit.

Jobs reside in [jobs/](./jobs/). From there, [`generate.go`](./generate.go) will process the config and turn them into a valid [prow job](https://github.com/kubernetes/test-infra/blob/master/prow/jobs.md).

This generation layer simplifies the configuration and allows use to provide opinionated defaults.

## Global config

In the root folder, a `.global.yaml` file can be added to define the config fields that are shared by all the meta config files.

Below is an example global config file:

```yaml
# The header line that will be added to each generated config file.
autogen_header: "# THIS FILE IS AUTOGENERATED. See prow/config/README.md\n"

# A map of org:alias.
# Jobs configured with the org in this map will have its `path_alias` field.
path_aliases:
  istio: istio.io

# Testgrid config for all the jobs.
# Note num_failures_to_alert will only be set for postsubmit and periodic jobs.
testgrid_config:
  enabled: true
  alert_email: istio-oncall@googlegroups.com
  num_failures_to_alert: "1"

# A map of preset resource allocations that can be referenced in each meta config file.
resources:
  default:
    limits:
      cpu: 3000m
      memory: 24Gi
    requests:
      cpu: 1000m
      memory: 3Gi

# The default dependencies for all the jobs.
base_requirements: [cache]
# A map of dependency presets that can be referenced in each meta config file.
requirement_presets:
  kind:
    volumeMounts:
    - mountPath: /lib/modules
      name: modules
      readOnly: true
    - mountPath: /sys/fs/cgroup
      name: cgroup
      readOnly: true
    - mountPath: /var/lib/docker
      name: docker-root
    volumes:
    - hostPath:
        path: /lib/modules
        type: Directory
      name: modules
    - hostPath:
        path: /sys/fs/cgroup
        type: Directory
      name: cgroup
    - emptyDir: {}
      name: docker-root
  cache:
    volumeMounts:
    - mountPath: /home/prow/go/pkg
      name: build-cache
      subPath: gomod
    volumes:
    - hostPath:
        path: /tmp/prow/cache
        type: DirectoryOrCreate
      name: build-cache
  gcp:
    labels:
      preset-service-account: "true"
```

## Job Syntax

Any number of yaml files can be added to configure the Prow jobs for each org/repo:branches.

Before is an example, annotated job config

```yaml
# REQUIRED. Defines what org these jobs should run for
org: istio
# REQUIRED. Defines what repo these jobs should run for
repo: istio

# Defines what branches to run these jobs for. Multiple can be provided
# The branch name will be appended to the job name (e.g tests -> tests-master)
# If this is not supplied, it defaults to master
branches:
  - master

# REQUIRED. Defines the image that will be used to run the jobs
image: gcr.io/istio-testing/build-tools:master

# Determines whether this configuration can be automatically cloned to create a release branch
# version
supports_release_branching: false

# A matrix can contain arbitrary number of dimensions, and can be used to easily define a combination of Prow jobs.
# Each dimension will only be respected for computation if they are referenced in the Prow job config, and the syntax
# to use the dimension is $(matrix.dimension_name)
matrix:
  greet: [hey, hello, hi]
  name: [foo, bar]

# Defines the actual jobs
jobs:
  # A basic test requires just a name and a command to run
  - name: unit-tests
    command: [make, test]
  - name: integration-tests
    # types defines when the job will run. Valid options are [presubmit, postsubmit, periodic].
    # by default a presubmit and postsubmit job will be created with the same config
    types: [postsubmit]
    # resources determines what resource requests and limits to use.
    # It can be one of the preset resource allocations defined in the global config and file config.
    # If omitted, default will be used if it is provided.
    resources: large
    command: [prow/istio-lint.sh]
    # requirements specify what dependencies a test has.
    # The options can be any of the preset requirements specified in the requirement_presets field in the global config and file config.
    requirements: [gcp]
  - name: hello-world
    command: [echo, "hello world"]
    # modifiers change various parts of the test config. See the values below
    modifiers:
    - skipped # if set, the test will run only in postsubmit or by explicitly calling /test on it
    - hidden # if set, the test will run but not be reported to the GitHub UI
    - optional # if set, the test will not be required
  - name: $(matrix.greet)-$(matrix.name)
    # Prow jobs will be generated based on the combinations of each dimension.
    # In this case 3*2=6 Prow jobs will be generated.
    command: [echo, "${matrix.greet} $(matrix.name)"]

# Defines preset resource allocations for tests
# The map here will be intersected with the map in the global config (if there is),
# and overwrite the value if the names are duplicated.
resources:
  default:
    requests:
      memory: "3Gi"
      cpu: "3000m"
    limits:
      memory: "24Gi"
      cpu: "3000m"
  # Define another preset, "large", with higher allocations
  large:
    requests:
      memory: "16Gi"
      cpu: "3000m"
    limits:
      memory: "24Gi"
      cpu: "3000m"
# Defines preset dependencies for tests
# The map here will be intersected with the map in the global config (if there is),
# and overwrite the value if the names are duplicated.
requirement_presets:
  github:
    volumeMounts:
    - mountPath: /etc/github-token
      name: github
      readOnly: true
    volumes:
    - name: github
      secret:
        secretName: oauth-token
```

## Generating the config

You can generate the config with:

```bash
$ make generate-config
```

You can also run the command directly, which provides more options:

```bash
$ cd prow/config/cmd
$ go run generate.go [diff|print|write|check|branch]
```

for example, to generate jobs for 1.8 branch, run:

```bash
$ go run generate.go branch 1.8
```

* diff will produce a semantic diff of the current config and the newly generated config. This is useful when making changes
* print will print out all generated config to stdout
* write will write out generated config to the appropriate job file
* check will strictly compare the generated config to the current config, and fail if there are any differences. This is useful for a CI gate to ensure config is up to date
* branch will create new job configurations for a new release branch. Invoke with a release name (e.g. "1.4")
